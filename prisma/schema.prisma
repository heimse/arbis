// Prisma Schema для BuildPlanner
// 
// ПЕРЕД ИСПОЛЬЗОВАНИЕМ:
// 1. Установите зависимости:
//    npm install prisma @prisma/client
//    npx prisma init
// 
// 2. Установите NextAuth и адаптер:
//    npm install next-auth @next-auth/prisma-adapter
// 
// 3. Установите bcrypt для хеширования паролей:
//    npm install bcryptjs
//    npm install --save-dev @types/bcryptjs
// 
// 4. Настройте .env файл:
//    DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DB_NAME?schema=public"
//    NEXTAUTH_SECRET="ваш-секретный-ключ-минимум-32-символа"
//    NEXTAUTH_URL="http://localhost:3000"
// 
// 5. Выполните миграцию:
//    npx prisma migrate dev --name init
// 
// 6. Сгенерируйте Prisma Client:
//    npx prisma generate

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// МОДЕЛИ ДЛЯ NEXTAUTH
// ============================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  passwordHash String?   // для credentials (может быть null, если OAuth)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Связи с NextAuth
  accounts Account[]
  sessions Session[]

  // Связи с доменными сущностями
  projects Project[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================
// ДОМЕННЫЕ МОДЕЛИ BUILDPLANNER
// ============================================================

model Project {
  id        String   @id @default(cuid())
  userId    String
  title     String
  type      String?  // "apartment" | "house" | "office"
  area      Float?   // площадь в м²
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Связи с другими сущностями проекта
  plans     PlanVersion[]
  messages  ChatMessage[]
  documents Document[]

  @@map("projects")
}

model PlanVersion {
  id          String   @id @default(cuid())
  projectId   String
  version     Int      // 1, 2, 3...
  name        String
  data        Json     // JSON-модель планировки (rooms, walls, furniture и т.д.)
  normsStatus String?  // "green" | "yellow" | "red"
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@map("plan_versions")
}

model ChatMessage {
  id          String   @id @default(cuid())
  projectId   String
  role        String   // "user" | "assistant" | "system"
  content     String   @db.Text
  attachments Json?    // массив файлов/ссылок
  createdAt   DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model Document {
  id        String   @id @default(cuid())
  projectId String
  type      String   // "bti_plan" | "walls_drawings" | "general_plan" | "norms_list" | "materials" | "approval_package"
  fileUrl   String
  meta      Json?    // дополнительные метаданные документа
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("documents")
}

